#cloud-config

# Oracle Cloud Compute Instance Setup
# Automatically installs Docker, Docker Compose, and prepares for application deployment

package_update: true
package_upgrade: true

packages:
  - docker.io
  - docker-compose
  - curl
  - jq
  - unzip
  - libaio1
  - wget

runcmd:
  # Enable and start Docker
  - systemctl enable docker
  - systemctl start docker

  # Add ubuntu user to docker group
  - usermod -aG docker ubuntu

  # Wait for Docker to be fully ready
  - sleep 5

  # Create application directory
  - mkdir -p /home/ubuntu/payment-service
  - chown -R ubuntu:ubuntu /home/ubuntu/payment-service

  # Create Oracle wallet directory
  - mkdir -p /home/ubuntu/oracle-wallet
  - chown -R ubuntu:ubuntu /home/ubuntu/oracle-wallet

  # Configure firewall
  - ufw allow 22/tcp    # SSH
  - ufw allow 8080/tcp  # gRPC
  - ufw allow 8081/tcp  # HTTP Cron
  - ufw --force enable

  # Install Oracle Instant Client (for database migrations and SQL*Plus)
  - |
    echo "ðŸ“¦ Installing Oracle Instant Client..."
    mkdir -p /opt/oracle
    cd /tmp
    wget -q https://download.oracle.com/otn_software/linux/instantclient/211000/instantclient-basic-linux.x64-21.1.0.0.0.zip
    wget -q https://download.oracle.com/otn_software/linux/instantclient/211000/instantclient-sqlplus-linux.x64-21.1.0.0.0.zip
    unzip -q -o instantclient-basic-linux.x64-21.1.0.0.0.zip -d /opt/oracle/
    unzip -q -o instantclient-sqlplus-linux.x64-21.1.0.0.0.zip -d /opt/oracle/
    sh -c "echo /opt/oracle/instantclient_21_1 > /etc/ld.so.conf.d/oracle-instantclient.conf"
    ldconfig
    rm -f instantclient-*.zip
    echo "âœ… Oracle Instant Client installed"

  # Login to Oracle Container Registry (OCIR)
  # This persists Docker credentials so docker-compose can pull images
  - |
    echo "${ocir_auth_token}" | docker login ${ocir_region}.ocir.io \
      -u "${ocir_username}" \
      --password-stdin

  # Create .env file for application
  - |
    cat > /home/ubuntu/payment-service/.env <<EOF
    # Environment
    ENVIRONMENT=${environment}

    # Oracle Container Registry (OCIR)
    OCIR_REGION=${ocir_region}
    OCIR_NAMESPACE=${ocir_namespace}

    # Database (Oracle Autonomous Database)
    DB_HOST=${db_connection_string}
    DB_PORT=1522
    DB_USER=${db_user}
    DB_PASSWORD=${db_password}
    DB_NAME=paymentdb
    DB_SSLMODE=require
    TNS_ADMIN=/home/ubuntu/oracle-wallet

    # Server
    GRPC_PORT=8080
    HTTP_PORT=8081

    # EPX Payment Gateway Configuration
    # Note: Merchant credentials (CUST_NBR, MERCH_NBR, DBA_NBR, TERMINAL_NBR) are
    # stored per-agent in the database following multi-tenant architecture.
    # Only the MAC secret for the test merchant is provided here for staging.
    EPX_SERVER_POST_URL=https://secure.epxuap.com
    EPX_TIMEOUT=30
    EPX_TEST_AGENT_MAC=${epx_mac}

    # North Merchant Reporting API
    NORTH_MERCHANT_REPORTING_URL=https://api.north.com
    NORTH_TIMEOUT=30

    # Cron Security
    CRON_SECRET=${cron_secret}

    # Logging
    LOG_LEVEL=info
    EOF

  - chown ubuntu:ubuntu /home/ubuntu/payment-service/.env
  - chmod 600 /home/ubuntu/payment-service/.env

  # Create docker-compose.yml
  - |
    cat > /home/ubuntu/payment-service/docker-compose.yml <<EOF
    version: '3.8'

    services:
      payment-service:
        image: ${ocir_region}.ocir.io/${ocir_namespace}/payment-service:latest
        container_name: payment-${environment}
        restart: unless-stopped
        ports:
          - "8080:8080"  # gRPC
          - "8081:8081"  # HTTP Cron
        env_file:
          - .env
        volumes:
          - /home/ubuntu/oracle-wallet:/home/ubuntu/oracle-wallet:ro
        healthcheck:
          test: ["CMD", "curl", "-f", "http://localhost:8081/cron/health"]
          interval: 30s
          timeout: 10s
          retries: 3
          start_period: 40s
        logging:
          driver: "json-file"
          options:
            max-size: "10m"
            max-file: "3"
    EOF

  - chown ubuntu:ubuntu /home/ubuntu/payment-service/docker-compose.yml

write_files:
  - path: /etc/motd
    content: |
      ==========================================
      Payment Service - ${environment}
      ==========================================

      Application:  /home/ubuntu/payment-service
      Wallet:       /home/ubuntu/oracle-wallet

      View logs:    docker logs payment-${environment} -f
      Restart:      cd ~/payment-service && docker-compose restart
      Deploy:       cd ~/payment-service && docker-compose pull && docker-compose up -d

      ==========================================
    owner: root:root
    permissions: '0644'

final_message: "Payment service instance is ready! Deployed in ${environment} environment."
