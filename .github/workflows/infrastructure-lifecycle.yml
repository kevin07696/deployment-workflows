name: Infrastructure Lifecycle Management

on:
  workflow_call:
    inputs:
      action:
        required: true
        type: string
        description: 'Action to perform: create, destroy, or check'
      environment:
        required: true
        type: string
        description: 'Environment (staging or production)'
      terraform-directory:
        required: false
        type: string
        default: 'deployment-workflows/terraform/oracle-staging'
        description: 'Terraform directory in deployment-workflows repo'
    secrets:
      OCI_USER_OCID:
        required: true
      OCI_TENANCY_OCID:
        required: true
      OCI_COMPARTMENT_OCID:
        required: true
      OCI_REGION:
        required: true
      OCI_FINGERPRINT:
        required: true
      OCI_PRIVATE_KEY:
        required: true
      ORACLE_DB_ADMIN_PASSWORD:
        required: true
      ORACLE_DB_PASSWORD:
        required: true
      EPX_MAC_STAGING:
        required: true
      CRON_SECRET_STAGING:
        required: true
      SSH_PUBLIC_KEY:
        required: false
      OCIR_REGION:
        required: true
      OCIR_TENANCY_NAMESPACE:
        required: true
    outputs:
      infrastructure_exists:
        description: 'Whether infrastructure exists'
        value: ${{ jobs.manage.outputs.infrastructure_exists }}
      oracle_cloud_host:
        description: 'Oracle Cloud host IP'
        value: ${{ jobs.manage.outputs.oracle_cloud_host }}
      db_connection_string:
        description: 'Oracle Database connection string'
        value: ${{ jobs.manage.outputs.db_connection_string }}
      db_user:
        description: 'Database application user'
        value: ${{ jobs.manage.outputs.db_user }}
  workflow_dispatch:
    inputs:
      action:
        required: true
        type: choice
        options:
          - create
          - destroy
          - check
        description: 'Action to perform: create, destroy, or check'
      environment:
        required: true
        type: choice
        options:
          - staging
          - production
        description: 'Environment (staging or production)'
      terraform-directory:
        required: false
        type: string
        default: 'deployment-workflows/terraform/oracle-staging'
        description: 'Terraform directory in deployment-workflows repo'

jobs:
  manage:
    name: ${{ inputs.action }} Infrastructure
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    outputs:
      infrastructure_exists: ${{ steps.check.outputs.exists }}
      oracle_cloud_host: ${{ steps.output.outputs.host }}
      db_connection_string: ${{ steps.output.outputs.db_connection_string }}
      db_user: ${{ steps.output.outputs.db_user }}

    steps:
      - name: Checkout deployment-workflows (for terraform)
        uses: actions/checkout@v4
        with:
          repository: kevin07696/deployment-workflows
          path: deployment-workflows

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.6.0'
          terraform_wrapper: false

      - name: Configure Oracle Cloud credentials
        run: |
          mkdir -p ~/.oci
          cat > ~/.oci/config <<EOF
          [DEFAULT]
          user=${{ secrets.OCI_USER_OCID }}
          fingerprint=${{ secrets.OCI_FINGERPRINT }}
          tenancy=${{ secrets.OCI_TENANCY_OCID }}
          region=${{ secrets.OCI_REGION }}
          key_file=~/.oci/oci_api_key.pem
          EOF

          echo "${{ secrets.OCI_PRIVATE_KEY }}" > ~/.oci/oci_api_key.pem
          chmod 600 ~/.oci/oci_api_key.pem

      - name: Validate Secrets
        run: |
          # Validate Oracle database admin password meets requirements (12-30 chars)
          DB_ADMIN_PW="${{ secrets.ORACLE_DB_ADMIN_PASSWORD }}"
          PW_LENGTH=${#DB_ADMIN_PW}

          echo "ðŸ” Validating secrets..."
          echo "  Admin password length: $PW_LENGTH characters"

          if [ $PW_LENGTH -lt 12 ]; then
            echo "âŒ ERROR: Admin password too short ($PW_LENGTH chars)"
            echo "   Oracle requires 12-30 characters"
            exit 1
          fi

          if [ $PW_LENGTH -gt 30 ]; then
            echo "âŒ ERROR: Admin password too long ($PW_LENGTH chars)"
            exit 1
          fi

          echo "âœ… Password validation passed ($PW_LENGTH chars)"

      - name: Mask Sensitive Values
        run: |
          echo "ðŸ”’ Masking sensitive values in logs..."
          echo "::add-mask::${{ secrets.ORACLE_DB_ADMIN_PASSWORD }}"
          echo "::add-mask::${{ secrets.ORACLE_DB_PASSWORD }}"
          echo "::add-mask::${{ secrets.EPX_MAC_STAGING }}"
          echo "::add-mask::${{ secrets.CRON_SECRET_STAGING }}"
          echo "::add-mask::${{ secrets.OCI_PRIVATE_KEY }}"
          echo "::add-mask::${{ secrets.OCI_FINGERPRINT }}"
          echo "âœ… Sensitive values masked"

      - name: Restore Terraform State
        uses: actions/cache/restore@v4
        with:
          path: ${{ inputs.terraform-directory }}/terraform.tfstate
          key: terraform-state-${{ inputs.environment }}

      - name: Terraform Init
        working-directory: ${{ inputs.terraform-directory }}
        run: terraform init

      - name: Check Infrastructure State
        id: check
        working-directory: ${{ inputs.terraform-directory }}
        run: |
          # Check if infrastructure exists
          if terraform show &> /dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âœ… Infrastructure exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Infrastructure does not exist"
          fi

      - name: Terraform Plan
        if: inputs.action == 'create' || inputs.action == 'check'
        working-directory: ${{ inputs.terraform-directory }}
        run: |
          terraform plan -out=tfplan
          terraform show -no-color tfplan > plan.txt
        env:
          # OCI Authentication
          TF_VAR_tenancy_ocid: ${{ secrets.OCI_TENANCY_OCID }}
          TF_VAR_user_ocid: ${{ secrets.OCI_USER_OCID }}
          TF_VAR_fingerprint: ${{ secrets.OCI_FINGERPRINT }}
          TF_VAR_region: ${{ secrets.OCI_REGION }}
          TF_VAR_compartment_ocid: ${{ secrets.OCI_COMPARTMENT_OCID }}
          TF_VAR_private_key: ${{ secrets.OCI_PRIVATE_KEY }}
          # Database Passwords
          TF_VAR_db_admin_password: ${{ secrets.ORACLE_DB_ADMIN_PASSWORD }}
          TF_VAR_db_app_password: ${{ secrets.ORACLE_DB_PASSWORD }}
          # Application Secrets
          TF_VAR_epx_mac: ${{ secrets.EPX_MAC_STAGING }}
          TF_VAR_cron_secret: ${{ secrets.CRON_SECRET_STAGING }}
          # Environment
          TF_VAR_environment: ${{ inputs.environment }}
          # OCIR Configuration
          TF_VAR_ocir_region: ${{ secrets.OCIR_REGION }}
          TF_VAR_ocir_namespace: ${{ secrets.OCIR_TENANCY_NAMESPACE }}
          # SSH Access
          TF_VAR_ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY }}

      - name: Upload Plan
        if: inputs.action == 'create' || inputs.action == 'check'
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-${{ inputs.environment }}
          path: ${{ inputs.terraform-directory }}/plan.txt

      - name: Terraform Apply
        if: inputs.action == 'create'
        working-directory: ${{ inputs.terraform-directory }}
        run: |
          echo "ðŸš€ Creating ${{ inputs.environment }} infrastructure..."
          terraform apply -auto-approve tfplan
          echo "âœ… Infrastructure created successfully"
        env:
          # OCI Authentication
          TF_VAR_tenancy_ocid: ${{ secrets.OCI_TENANCY_OCID }}
          TF_VAR_user_ocid: ${{ secrets.OCI_USER_OCID }}
          TF_VAR_fingerprint: ${{ secrets.OCI_FINGERPRINT }}
          TF_VAR_region: ${{ secrets.OCI_REGION }}
          TF_VAR_compartment_ocid: ${{ secrets.OCI_COMPARTMENT_OCID }}
          TF_VAR_private_key: ${{ secrets.OCI_PRIVATE_KEY }}
          # Database Passwords
          TF_VAR_db_admin_password: ${{ secrets.ORACLE_DB_ADMIN_PASSWORD }}
          TF_VAR_db_app_password: ${{ secrets.ORACLE_DB_PASSWORD }}
          # Application Secrets
          TF_VAR_epx_mac: ${{ secrets.EPX_MAC_STAGING }}
          TF_VAR_cron_secret: ${{ secrets.CRON_SECRET_STAGING }}
          # Environment
          TF_VAR_environment: ${{ inputs.environment }}
          # OCIR Configuration
          TF_VAR_ocir_region: ${{ secrets.OCIR_REGION }}
          TF_VAR_ocir_namespace: ${{ secrets.OCIR_TENANCY_NAMESPACE }}
          # SSH Access
          TF_VAR_ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY }}

      - name: Terraform Destroy
        if: inputs.action == 'destroy'
        working-directory: ${{ inputs.terraform-directory }}
        run: |
          echo "ðŸ—‘ï¸ Destroying ${{ inputs.environment }} infrastructure..."
          terraform destroy -auto-approve
          echo "âœ… Infrastructure destroyed successfully"
        env:
          # OCI Authentication
          TF_VAR_tenancy_ocid: ${{ secrets.OCI_TENANCY_OCID }}
          TF_VAR_user_ocid: ${{ secrets.OCI_USER_OCID }}
          TF_VAR_fingerprint: ${{ secrets.OCI_FINGERPRINT }}
          TF_VAR_region: ${{ secrets.OCI_REGION }}
          TF_VAR_compartment_ocid: ${{ secrets.OCI_COMPARTMENT_OCID }}
          TF_VAR_private_key: ${{ secrets.OCI_PRIVATE_KEY }}
          # Database Passwords
          TF_VAR_db_admin_password: ${{ secrets.ORACLE_DB_ADMIN_PASSWORD }}
          TF_VAR_db_app_password: ${{ secrets.ORACLE_DB_PASSWORD }}
          # Application Secrets
          TF_VAR_epx_mac: ${{ secrets.EPX_MAC_STAGING }}
          TF_VAR_cron_secret: ${{ secrets.CRON_SECRET_STAGING }}
          # Environment
          TF_VAR_environment: ${{ inputs.environment }}
          # OCIR Configuration
          TF_VAR_ocir_region: ${{ secrets.OCIR_REGION }}
          TF_VAR_ocir_namespace: ${{ secrets.OCIR_TENANCY_NAMESPACE }}
          # SSH Access
          TF_VAR_ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY }}

      - name: Export Outputs
        id: output
        if: inputs.action == 'create' && success()
        working-directory: ${{ inputs.terraform-directory }}
        run: |
          echo "Extracting Terraform outputs..."

          ORACLE_HOST=$(terraform output -raw oracle_cloud_host 2>/dev/null || echo "")
          echo "host=${ORACLE_HOST}" >> $GITHUB_OUTPUT

          # Extract database connection string (HIGH priority connection)
          # Oracle connection_strings is an array, so access the first element
          DB_CONN_STRINGS=$(terraform output -json database_connection_strings 2>/dev/null || echo "[]")
          DB_CONN_HIGH=$(echo "$DB_CONN_STRINGS" | jq -r '.[0].profiles[0].value // .[0].all_connection_strings.high // ""')
          echo "db_connection_string=${DB_CONN_HIGH}" >> $GITHUB_OUTPUT

          # Database user is hardcoded in Terraform
          echo "db_user=payment_service" >> $GITHUB_OUTPUT

          echo "## Terraform Outputs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Oracle Cloud Host:** ${ORACLE_HOST}" >> $GITHUB_STEP_SUMMARY
          echo "**Database User:** payment_service" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Required GitHub Secrets" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          terraform output -raw github_secrets >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Save Wallet
        if: inputs.action == 'create' && success()
        uses: actions/upload-artifact@v4
        with:
          name: oracle-wallet-${{ inputs.environment }}
          path: ${{ inputs.terraform-directory }}/oracle-wallet.zip
          retention-days: 7

      - name: Save Terraform State
        if: always()
        uses: actions/cache/save@v4
        with:
          path: ${{ inputs.terraform-directory }}/terraform.tfstate
          key: terraform-state-${{ inputs.environment }}

      - name: Generate Summary
        if: always()
        run: |
          echo "## Infrastructure ${{ inputs.action }} - ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Action:** ${{ inputs.action }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u)" >> $GITHUB_STEP_SUMMARY
