name: Infrastructure Lifecycle Management

on:
  workflow_call:
    inputs:
      action:
        required: true
        type: string
        description: 'Action to perform: create, destroy, or check'
      environment:
        required: true
        type: string
        description: 'Environment (staging or production)'
      terraform-directory:
        required: false
        type: string
        default: 'deployment-workflows/terraform/oracle-staging'
        description: 'Terraform directory in deployment-workflows repo'
    secrets:
      OCI_USER_OCID:
        required: true
      OCI_TENANCY_OCID:
        required: true
      OCI_COMPARTMENT_OCID:
        required: true
      OCI_REGION:
        required: true
      OCI_FINGERPRINT:
        required: true
      OCI_PRIVATE_KEY:
        required: true
      ORACLE_DB_ADMIN_PASSWORD:
        required: true
      ORACLE_DB_PASSWORD:
        required: true
      EPX_MAC_STAGING:
        required: true
      CRON_SECRET_STAGING:
        required: true
      SSH_PUBLIC_KEY:
        required: false
      OCIR_REGION:
        required: true
      OCIR_TENANCY_NAMESPACE:
        required: true
      OCIR_USERNAME:
        required: true
      OCIR_AUTH_TOKEN:
        required: true
    outputs:
      infrastructure_exists:
        description: 'Whether infrastructure exists'
        value: ${{ jobs.manage.outputs.infrastructure_exists }}
      oracle_cloud_host:
        description: 'Oracle Cloud host IP'
        value: ${{ jobs.manage.outputs.oracle_cloud_host }}
      db_host:
        description: 'Database connection host'
        value: ${{ jobs.manage.outputs.db_host }}
      db_port:
        description: 'Database connection port'
        value: ${{ jobs.manage.outputs.db_port }}
      db_service_name:
        description: 'Database service name'
        value: ${{ jobs.manage.outputs.db_service_name }}
      db_name:
        description: 'Database name'
        value: ${{ jobs.manage.outputs.db_name }}
      db_user:
        description: 'Database application user'
        value: ${{ jobs.manage.outputs.db_user }}
  workflow_dispatch:
    inputs:
      action:
        required: true
        type: choice
        options:
          - create
          - destroy
          - check
        description: 'Action to perform: create, destroy, or check'
      environment:
        required: true
        type: choice
        options:
          - staging
          - production
        description: 'Environment (staging or production)'
      terraform-directory:
        required: false
        type: string
        default: 'deployment-workflows/terraform/oracle-staging'
        description: 'Terraform directory in deployment-workflows repo'

jobs:
  manage:
    name: ${{ inputs.action }} Infrastructure
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    outputs:
      infrastructure_exists: ${{ steps.check.outputs.exists }}
      oracle_cloud_host: ${{ steps.output.outputs.host }}
      db_host: ${{ steps.output.outputs.db_host }}
      db_port: ${{ steps.output.outputs.db_port }}
      db_service_name: ${{ steps.output.outputs.db_service_name }}
      db_name: ${{ steps.output.outputs.db_name }}
      db_user: ${{ steps.output.outputs.db_user }}

    steps:
      - name: Checkout deployment-workflows (for terraform)
        uses: actions/checkout@v4
        with:
          repository: kevin07696/deployment-workflows
          path: deployment-workflows

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.6.0'
          terraform_wrapper: false

      - name: Configure Oracle Cloud credentials
        run: |
          mkdir -p ~/.oci
          cat > ~/.oci/config <<EOF
          [DEFAULT]
          user=${{ secrets.OCI_USER_OCID }}
          fingerprint=${{ secrets.OCI_FINGERPRINT }}
          tenancy=${{ secrets.OCI_TENANCY_OCID }}
          region=${{ secrets.OCI_REGION }}
          key_file=~/.oci/oci_api_key.pem
          EOF

          echo "${{ secrets.OCI_PRIVATE_KEY }}" > ~/.oci/oci_api_key.pem
          chmod 600 ~/.oci/oci_api_key.pem

      - name: Validate Secrets
        run: |
          # Validate Oracle database admin password meets requirements (12-30 chars)
          DB_ADMIN_PW="${{ secrets.ORACLE_DB_ADMIN_PASSWORD }}"
          PW_LENGTH=${#DB_ADMIN_PW}

          echo "ðŸ” Validating secrets..."
          echo "  Admin password length: $PW_LENGTH characters"

          if [ $PW_LENGTH -lt 12 ]; then
            echo "âŒ ERROR: Admin password too short ($PW_LENGTH chars)"
            echo "   Oracle requires 12-30 characters"
            exit 1
          fi

          if [ $PW_LENGTH -gt 30 ]; then
            echo "âŒ ERROR: Admin password too long ($PW_LENGTH chars)"
            exit 1
          fi

          echo "âœ… Password validation passed ($PW_LENGTH chars)"

      - name: Mask Sensitive Values
        run: |
          echo "ðŸ”’ Masking sensitive values in logs..."
          echo "::add-mask::${{ secrets.ORACLE_DB_ADMIN_PASSWORD }}"
          echo "::add-mask::${{ secrets.ORACLE_DB_PASSWORD }}"
          echo "::add-mask::${{ secrets.EPX_MAC_STAGING }}"
          echo "::add-mask::${{ secrets.CRON_SECRET_STAGING }}"
          echo "::add-mask::${{ secrets.OCI_PRIVATE_KEY }}"
          echo "::add-mask::${{ secrets.OCI_FINGERPRINT }}"
          echo "::add-mask::${{ secrets.OCIR_USERNAME }}"
          echo "::add-mask::${{ secrets.OCIR_AUTH_TOKEN }}"
          echo "âœ… Sensitive values masked"

      - name: Verify OCI CLI Configuration
        if: inputs.action == 'create'
        run: |
          echo "ðŸ” Verifying OCI CLI setup..."

          # Check OCI CLI is installed
          if ! command -v oci &> /dev/null; then
            echo "âŒ OCI CLI not found, installing..."
            bash -c "$(curl -L https://raw.githubusercontent.com/oracle/oci-cli/master/scripts/install/install.sh)" -- --accept-all-defaults
            echo "$HOME/bin" >> $GITHUB_PATH
          else
            echo "âœ… OCI CLI version: $(oci --version)"
          fi

          # Test OCI authentication
          echo "Testing OCI authentication..."
          if oci iam region list --limit 1 >/dev/null 2>&1; then
            echo "âœ… OCI authentication successful"
          else
            echo "âŒ OCI authentication failed - checking config..."
            cat ~/.oci/config
            exit 1
          fi

      - name: Verify and Cleanup Orphaned Resources
        if: inputs.action == 'create'
        run: |
          echo "ðŸ” Checking for orphaned OCI resources..."

          # Check for orphaned Autonomous Databases
          echo "Checking databases..."
          DB_COUNT=$(oci db autonomous-database list \
            --compartment-id ${{ secrets.OCI_COMPARTMENT_OCID }} \
            --lifecycle-state AVAILABLE \
            --all | \
            jq '([.data[]? | select(."display-name" | contains("payment-${{ inputs.environment }}"))] | length) // 0')

          echo "Found $DB_COUNT orphaned database(s)"

          if [ "$DB_COUNT" -gt 0 ]; then
            echo "ðŸ§¹ Cleaning up orphaned databases..."
            oci db autonomous-database list \
              --compartment-id ${{ secrets.OCI_COMPARTMENT_OCID }} \
              --lifecycle-state AVAILABLE \
              --all | \
              jq -r '.data[] | select(."display-name" | contains("payment-${{ inputs.environment }}")) | .id' | \
              while read db_id; do
                echo "  Deleting database: $db_id"
                oci db autonomous-database delete --autonomous-database-id "$db_id" --force || true
            done

            echo "â³ Waiting for database deletions to complete..."
            for i in {1..30}; do
              REMAINING=$(oci db autonomous-database list \
                --compartment-id ${{ secrets.OCI_COMPARTMENT_OCID }} \
                --all | \
                jq '([.data[]? | select(."display-name" | contains("payment-${{ inputs.environment }}")) | select(."lifecycle-state" == "AVAILABLE" or ."lifecycle-state" == "TERMINATING")] | length) // 0')

              if [ "$REMAINING" -eq 0 ]; then
                echo "âœ… All databases deleted"
                break
              fi

              echo "  $REMAINING database(s) still terminating... (attempt $i/30)"
              sleep 10
            done
          fi

          # Check for orphaned Compute Instances
          echo "Checking compute instances..."
          INSTANCE_COUNT=$(oci compute instance list \
            --compartment-id ${{ secrets.OCI_COMPARTMENT_OCID }} \
            --lifecycle-state RUNNING \
            --all | \
            jq '([.data[]? | select(."display-name" | contains("payment-${{ inputs.environment }}"))] | length) // 0')

          echo "Found $INSTANCE_COUNT orphaned instance(s)"

          if [ "$INSTANCE_COUNT" -gt 0 ]; then
            echo "ðŸ§¹ Cleaning up orphaned compute instances..."
            oci compute instance list \
              --compartment-id ${{ secrets.OCI_COMPARTMENT_OCID }} \
              --lifecycle-state RUNNING \
              --all | \
              jq -r '.data[] | select(."display-name" | contains("payment-${{ inputs.environment }}")) | .id' | \
              while read instance_id; do
                echo "  Terminating instance: $instance_id"
                oci compute instance terminate --instance-id "$instance_id" --force || true
            done

            echo "â³ Waiting for instance terminations to complete..."
            sleep 20
          fi

          # Check Oracle Free Tier database quota
          echo "Checking Oracle Free Tier database quota..."
          TOTAL_DATABASES=$(oci db autonomous-database list \
            --compartment-id ${{ secrets.OCI_COMPARTMENT_OCID }} \
            --lifecycle-state AVAILABLE \
            --all | \
            jq '([.data[]? | select(.["is-free-tier"] == true)] | length) // 0')

          echo "Found $TOTAL_DATABASES Always Free database(s) in compartment (Oracle limit: 2)"

          if [ "$TOTAL_DATABASES" -ge 2 ]; then
            echo "âŒ ERROR: Oracle Free Tier database quota exceeded!"
            echo "You have $TOTAL_DATABASES Always Free databases, but Oracle only allows 2 per account."
            echo ""
            echo "Run cleanup script: ./scripts/cleanup-oracle-databases.sh"
            exit 1
          fi

          # Check Oracle Free Tier compute quota
          echo "Checking Oracle Free Tier compute quota..."
          TOTAL_INSTANCES=$(oci compute instance list \
            --compartment-id ${{ secrets.OCI_COMPARTMENT_OCID }} \
            --lifecycle-state RUNNING \
            --all | \
            jq '([.data[]?] | length) // 0')

          echo "Found $TOTAL_INSTANCES running instance(s) in compartment (Oracle limit: 2 Free Tier instances)"

          if [ "$TOTAL_INSTANCES" -ge 2 ]; then
            echo "âŒ ERROR: Oracle Free Tier compute quota exceeded!"
            echo "You have $TOTAL_INSTANCES running instances, but Oracle Free Tier limit is 2."
            echo ""
            echo "Orphaned instances found:"
            oci compute instance list \
              --compartment-id ${{ secrets.OCI_COMPARTMENT_OCID }} \
              --lifecycle-state RUNNING \
              --all | \
              jq -r '.data[]? | "  - \(."display-name") (ID: \(.id), Created: \(."time-created"))"'
            echo ""
            echo "Terminating orphaned instances automatically..."
            oci compute instance list \
              --compartment-id ${{ secrets.OCI_COMPARTMENT_OCID }} \
              --lifecycle-state RUNNING \
              --all | \
              jq -r '.data[]? | .id' | \
              while read instance_id; do
                echo "  Terminating: $instance_id"
                oci compute instance terminate --instance-id "$instance_id" --force || true
              done
            echo ""
            echo "â³ Waiting 30 seconds for terminations..."
            sleep 30
            echo "âœ… Compute quota freed"
          fi

          echo "âœ… Resource verification complete - ready for provisioning"

      - name: Restore Terraform State
        uses: actions/cache/restore@v4
        with:
          path: ${{ inputs.terraform-directory }}/terraform.tfstate
          key: terraform-state-${{ inputs.environment }}

      - name: Terraform Init
        working-directory: ${{ inputs.terraform-directory }}
        run: terraform init

      - name: Check Infrastructure State
        id: check
        working-directory: ${{ inputs.terraform-directory }}
        run: |
          # Check if infrastructure exists
          if terraform show &> /dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âœ… Infrastructure exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Infrastructure does not exist"
          fi

      - name: Terraform Plan
        if: inputs.action == 'create' || inputs.action == 'check'
        working-directory: ${{ inputs.terraform-directory }}
        run: |
          terraform plan -out=tfplan
          terraform show -no-color tfplan > plan.txt
        env:
          # OCI Authentication
          TF_VAR_tenancy_ocid: ${{ secrets.OCI_TENANCY_OCID }}
          TF_VAR_user_ocid: ${{ secrets.OCI_USER_OCID }}
          TF_VAR_fingerprint: ${{ secrets.OCI_FINGERPRINT }}
          TF_VAR_region: ${{ secrets.OCI_REGION }}
          TF_VAR_compartment_ocid: ${{ secrets.OCI_COMPARTMENT_OCID }}
          TF_VAR_private_key: ${{ secrets.OCI_PRIVATE_KEY }}
          # Database Passwords
          TF_VAR_db_admin_password: ${{ secrets.ORACLE_DB_ADMIN_PASSWORD }}
          TF_VAR_db_app_password: ${{ secrets.ORACLE_DB_PASSWORD }}
          # Application Secrets
          TF_VAR_epx_mac: ${{ secrets.EPX_MAC_STAGING }}
          TF_VAR_cron_secret: ${{ secrets.CRON_SECRET_STAGING }}
          # Environment
          TF_VAR_environment: ${{ inputs.environment }}
          # OCIR Configuration
          TF_VAR_ocir_region: ${{ secrets.OCIR_REGION }}
          TF_VAR_ocir_namespace: ${{ secrets.OCIR_TENANCY_NAMESPACE }}
          TF_VAR_ocir_username: ${{ secrets.OCIR_USERNAME }}
          TF_VAR_ocir_auth_token: ${{ secrets.OCIR_AUTH_TOKEN }}
          # SSH Access
          TF_VAR_ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY }}

      - name: Upload Plan
        if: inputs.action == 'create' || inputs.action == 'check'
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-${{ inputs.environment }}
          path: ${{ inputs.terraform-directory }}/plan.txt

      - name: Terraform Apply
        if: inputs.action == 'create'
        working-directory: ${{ inputs.terraform-directory }}
        run: |
          echo "ðŸš€ Creating ${{ inputs.environment }} infrastructure..."
          terraform apply -auto-approve tfplan
          echo "âœ… Infrastructure created successfully"
        env:
          # OCI Authentication
          TF_VAR_tenancy_ocid: ${{ secrets.OCI_TENANCY_OCID }}
          TF_VAR_user_ocid: ${{ secrets.OCI_USER_OCID }}
          TF_VAR_fingerprint: ${{ secrets.OCI_FINGERPRINT }}
          TF_VAR_region: ${{ secrets.OCI_REGION }}
          TF_VAR_compartment_ocid: ${{ secrets.OCI_COMPARTMENT_OCID }}
          TF_VAR_private_key: ${{ secrets.OCI_PRIVATE_KEY }}
          # Database Passwords
          TF_VAR_db_admin_password: ${{ secrets.ORACLE_DB_ADMIN_PASSWORD }}
          TF_VAR_db_app_password: ${{ secrets.ORACLE_DB_PASSWORD }}
          # Application Secrets
          TF_VAR_epx_mac: ${{ secrets.EPX_MAC_STAGING }}
          TF_VAR_cron_secret: ${{ secrets.CRON_SECRET_STAGING }}
          # Environment
          TF_VAR_environment: ${{ inputs.environment }}
          # OCIR Configuration
          TF_VAR_ocir_region: ${{ secrets.OCIR_REGION }}
          TF_VAR_ocir_namespace: ${{ secrets.OCIR_TENANCY_NAMESPACE }}
          TF_VAR_ocir_username: ${{ secrets.OCIR_USERNAME }}
          TF_VAR_ocir_auth_token: ${{ secrets.OCIR_AUTH_TOKEN }}
          # SSH Access
          TF_VAR_ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY }}

      - name: Cleanup Orphaned Resources (OCI CLI)
        if: inputs.action == 'destroy'
        run: |
          echo "ðŸ§¹ Cleaning up orphaned OCI resources before Terraform destroy..."

          # Find and delete orphaned databases
          echo "Looking for orphaned databases..."
          oci db autonomous-database list \
            --compartment-id ${{ secrets.OCI_COMPARTMENT_OCID }} \
            --all | \
            jq -r '.data[]? | select(."display-name" | contains("payment-${{ inputs.environment }}")) | select(."lifecycle-state" == "AVAILABLE" or ."lifecycle-state" == "PROVISIONING") | .id' | \
            while read db_id; do
              echo "  Deleting database: $db_id"
              oci db autonomous-database delete --autonomous-database-id "$db_id" --force || true
            done

          # Find and terminate orphaned compute instances
          echo "Looking for orphaned compute instances..."
          oci compute instance list \
            --compartment-id ${{ secrets.OCI_COMPARTMENT_OCID }} \
            --all | \
            jq -r '.data[]? | select(."display-name" | contains("payment-${{ inputs.environment }}")) | select(."lifecycle-state" == "RUNNING" or ."lifecycle-state" == "STARTING") | .id' | \
            while read instance_id; do
              echo "  Terminating instance: $instance_id"
              oci compute instance terminate --instance-id "$instance_id" --force || true
            done

          echo "â³ Waiting 30 seconds for resource deletions to process..."
          sleep 30
          echo "âœ… OCI CLI cleanup complete"

      - name: Terraform Destroy
        if: inputs.action == 'destroy'
        working-directory: ${{ inputs.terraform-directory }}
        run: |
          echo "ðŸ—‘ï¸ Destroying ${{ inputs.environment }} infrastructure..."
          terraform destroy -auto-approve
          echo "âœ… Infrastructure destroyed successfully"
        env:
          # OCI Authentication
          TF_VAR_tenancy_ocid: ${{ secrets.OCI_TENANCY_OCID }}
          TF_VAR_user_ocid: ${{ secrets.OCI_USER_OCID }}
          TF_VAR_fingerprint: ${{ secrets.OCI_FINGERPRINT }}
          TF_VAR_region: ${{ secrets.OCI_REGION }}
          TF_VAR_compartment_ocid: ${{ secrets.OCI_COMPARTMENT_OCID }}
          TF_VAR_private_key: ${{ secrets.OCI_PRIVATE_KEY }}
          # Database Passwords
          TF_VAR_db_admin_password: ${{ secrets.ORACLE_DB_ADMIN_PASSWORD }}
          TF_VAR_db_app_password: ${{ secrets.ORACLE_DB_PASSWORD }}
          # Application Secrets
          TF_VAR_epx_mac: ${{ secrets.EPX_MAC_STAGING }}
          TF_VAR_cron_secret: ${{ secrets.CRON_SECRET_STAGING }}
          # Environment
          TF_VAR_environment: ${{ inputs.environment }}
          # OCIR Configuration
          TF_VAR_ocir_region: ${{ secrets.OCIR_REGION }}
          TF_VAR_ocir_namespace: ${{ secrets.OCIR_TENANCY_NAMESPACE }}
          TF_VAR_ocir_username: ${{ secrets.OCIR_USERNAME }}
          TF_VAR_ocir_auth_token: ${{ secrets.OCIR_AUTH_TOKEN }}
          # SSH Access
          TF_VAR_ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY }}

      - name: Export Outputs
        id: output
        if: inputs.action == 'create' && success()
        working-directory: ${{ inputs.terraform-directory }}
        run: |
          echo "Extracting Terraform outputs..."

          ORACLE_HOST=$(terraform output -raw oracle_cloud_host 2>/dev/null || echo "")
          echo "host=${ORACLE_HOST}" >> $GITHUB_OUTPUT

          # Extract database connection components (pass separately to avoid GitHub masking)
          DB_HOST=$(terraform output -raw database_host 2>/dev/null || echo "")
          DB_PORT=$(terraform output -raw database_port 2>/dev/null || echo "1522")
          DB_SERVICE=$(terraform output -raw database_service_name 2>/dev/null || echo "")
          DB_NAME=$(terraform output -raw database_name 2>/dev/null || echo "")

          echo "db_host=${DB_HOST}" >> $GITHUB_OUTPUT
          echo "db_port=${DB_PORT}" >> $GITHUB_OUTPUT
          echo "db_service_name=${DB_SERVICE}" >> $GITHUB_OUTPUT
          echo "db_name=${DB_NAME}" >> $GITHUB_OUTPUT
          echo "db_user=payment_service" >> $GITHUB_OUTPUT

          echo "## Terraform Outputs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Oracle Cloud Host:** ${ORACLE_HOST}" >> $GITHUB_STEP_SUMMARY
          echo "**Database User:** payment_service" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Required GitHub Secrets" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          terraform output -raw github_secrets >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Save Wallet
        if: inputs.action == 'create' && success()
        uses: actions/upload-artifact@v4
        with:
          name: oracle-wallet-${{ inputs.environment }}
          path: ${{ inputs.terraform-directory }}/oracle-wallet.zip
          retention-days: 7

      - name: Save SSH Private Key
        if: inputs.action == 'create' && success()
        uses: actions/upload-artifact@v4
        with:
          name: oracle-ssh-key-${{ inputs.environment }}
          path: ${{ inputs.terraform-directory }}/oracle-staging-key
          retention-days: 7

      - name: Save Database Init Script
        if: inputs.action == 'create' && success()
        uses: actions/upload-artifact@v4
        with:
          name: db-init-script-${{ inputs.environment }}
          path: ${{ inputs.terraform-directory }}/init_db.sql
          retention-days: 7

      - name: Save Terraform State
        if: always()
        uses: actions/cache/save@v4
        with:
          path: ${{ inputs.terraform-directory }}/terraform.tfstate
          key: terraform-state-${{ inputs.environment }}

      - name: Generate Summary
        if: always()
        run: |
          echo "## Infrastructure ${{ inputs.action }} - ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Action:** ${{ inputs.action }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u)" >> $GITHUB_STEP_SUMMARY
