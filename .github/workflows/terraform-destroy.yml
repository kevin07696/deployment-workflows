name: Terraform Infrastructure Cleanup

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
        description: 'Environment to destroy (staging or production)'
      terraform-directory:
        required: false
        type: string
        default: 'terraform'
        description: 'Directory containing Terraform files'
      auto-approve:
        required: false
        type: boolean
        default: false
        description: 'Auto-approve terraform destroy'
    secrets:
      OCI_USER_OCID:
        required: true
      OCI_TENANCY_OCID:
        required: true
      OCI_COMPARTMENT_OCID:
        required: true
      OCI_REGION:
        required: true
      OCI_FINGERPRINT:
        required: true
      OCI_PRIVATE_KEY:
        required: true
      ORACLE_DB_ADMIN_PASSWORD:
        required: true
      ORACLE_DB_PASSWORD:
        required: true
      EPX_MAC_STAGING:
        required: true
      CRON_SECRET_STAGING:
        required: true
      SSH_PUBLIC_KEY:
        required: false
      OCIR_REGION:
        required: true
      OCIR_TENANCY_NAMESPACE:
        required: true
      OCIR_USERNAME:
        required: true
      OCIR_AUTH_TOKEN:
        required: true

jobs:
  cleanup:
    name: Cleanup Infrastructure
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    defaults:
      run:
        working-directory: ${{ inputs.terraform-directory }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Create terraform.tfvars
        run: |
          cat > terraform.tfvars <<EOF
          # OCI Authentication
          user_ocid         = "${{ secrets.OCI_USER_OCID }}"
          tenancy_ocid      = "${{ secrets.OCI_TENANCY_OCID }}"
          compartment_ocid  = "${{ secrets.OCI_COMPARTMENT_OCID }}"
          region            = "${{ secrets.OCI_REGION }}"
          fingerprint       = "${{ secrets.OCI_FINGERPRINT }}"
          private_key       = <<-EOK
          ${{ secrets.OCI_PRIVATE_KEY }}
          EOK

          # Environment
          environment = "${{ inputs.environment }}"

          # Database Configuration
          db_admin_password = "${{ secrets.ORACLE_DB_ADMIN_PASSWORD }}"
          db_app_password   = "${{ secrets.ORACLE_DB_PASSWORD }}"

          # Application Secrets
          epx_mac      = "${{ secrets.EPX_MAC_STAGING }}"
          cron_secret  = "${{ secrets.CRON_SECRET_STAGING }}"

          # Oracle Container Registry (OCIR)
          ocir_region     = "${{ secrets.OCIR_REGION }}"
          ocir_namespace  = "${{ secrets.OCIR_TENANCY_NAMESPACE }}"
          ocir_username   = "${{ secrets.OCIR_USERNAME }}"
          ocir_auth_token = "${{ secrets.OCIR_AUTH_TOKEN }}"

          # SSH Key (optional)
          ssh_public_key = "${{ secrets.SSH_PUBLIC_KEY }}"
          EOF

      - name: Terraform Init
        run: terraform init

      # Critical: Restore state BEFORE attempting to destroy resources
      # This prevents the timing race where OCI cleanup runs before state is restored
      - name: Download Terraform State (if exists)
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: terraform-state-${{ inputs.environment }}
          path: ${{ inputs.terraform-directory }}

      - name: Restore Terraform State
        continue-on-error: true
        run: |
          if [ -f terraform.tfstate ]; then
            echo "Restoring Terraform state..."
            cp terraform.tfstate terraform.tfstate.backup
            echo "State restored successfully"
          else
            echo "No state file to restore, continuing with fresh state"
          fi

      - name: Terraform Refresh
        continue-on-error: true
        run: |
          echo "Refreshing Terraform state from actual infrastructure..."
          terraform refresh || echo "Refresh failed, continuing with destroy"

      - name: Terraform Plan Destroy
        id: plan_destroy
        run: |
          terraform plan -destroy -out=destroy.tfplan
          terraform show -no-color destroy.tfplan > destroy_plan.txt

      - name: Upload Destroy Plan
        uses: actions/upload-artifact@v4
        with:
          name: terraform-destroy-plan-${{ inputs.environment }}
          path: ${{ inputs.terraform-directory }}/destroy_plan.txt

      - name: Terraform Destroy
        if: inputs.auto-approve == true || github.event_name == 'workflow_dispatch'
        run: |
          echo "Destroying infrastructure..."
          terraform destroy -auto-approve

          echo "✅ Infrastructure destroyed successfully"

      - name: Cleanup Artifacts
        if: success()
        run: |
          echo "Cleaning up local files..."
          rm -f oracle-staging-key oracle-wallet.zip init_db.sql terraform.tfstate*

      - name: Display Cleanup Summary
        if: success()
        run: |
          echo "=========================================="
          echo "✅ Infrastructure Cleanup Complete"
          echo "=========================================="
          echo ""
          echo "All resources have been destroyed:"
          echo "- Compute instance"
          echo "- Autonomous database"
          echo "- Networking (VCN, subnet, security lists)"
          echo ""
          echo "=========================================="
