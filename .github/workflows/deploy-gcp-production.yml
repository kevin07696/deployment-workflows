name: Deploy to Google Cloud Run Production

on:
  workflow_call:
    inputs:
      service-name:
        required: true
        type: string
        description: 'Name of the service to deploy'
      gcp-region:
        required: false
        type: string
        default: 'us-central1'
        description: 'GCP region for deployment'
    secrets:
      GCP_SA_KEY:
        required: true
      GCP_PROJECT_ID:
        required: true
      GCP_REGION:
        required: true
      GCP_DB_INSTANCE_CONNECTION_NAME:
        required: true
      GCP_DB_USER:
        required: true
      GCP_DB_PASSWORD:
        required: true
      GCP_DB_NAME:
        required: true
      GCP_DATABASE_URL:
        required: true
      EPX_CUST_NBR_PRODUCTION:
        required: true
      EPX_MERCH_NBR_PRODUCTION:
        required: true
      EPX_DBA_NBR_PRODUCTION:
        required: true
      EPX_TERMINAL_NBR_PRODUCTION:
        required: true
      EPX_MAC_PRODUCTION:
        required: true
      CRON_SECRET_PRODUCTION:
        required: true
      CALLBACK_BASE_URL_PRODUCTION:
        required: true

jobs:
  migrate:
    name: Run Database Migrations
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Install Goose
        run: go install github.com/pressly/goose/v3/cmd/goose@latest

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SQL Proxy
        run: |
          wget https://dl.google.com/cloudsql/cloud_sql_proxy.linux.amd64 -O cloud_sql_proxy
          chmod +x cloud_sql_proxy
          ./cloud_sql_proxy -instances=${{ secrets.GCP_DB_INSTANCE_CONNECTION_NAME }}=tcp:5432 &
          sleep 5

      - name: Run migrations on Cloud SQL
        env:
          DB_HOST: 127.0.0.1
          DB_PORT: 5432
          DB_USER: ${{ secrets.GCP_DB_USER }}
          DB_PASSWORD: ${{ secrets.GCP_DB_PASSWORD }}
          DB_NAME: ${{ secrets.GCP_DB_NAME }}
        run: |
          echo "ðŸ”„ Starting migrations for production database..."

          # Build connection string
          DATABASE_URL="postgresql://${DB_USER}:${DB_PASSWORD}@${DB_HOST}:${DB_PORT}/${DB_NAME}?sslmode=disable"

          # Run migrations
          goose -dir migrations postgres "$DATABASE_URL" up

          echo "âœ… Production migrations completed successfully"

  deploy:
    name: Deploy to Cloud Run
    needs: migrate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ secrets.GCP_REGION }}-docker.pkg.dev

      - name: Build and Push Docker Image
        env:
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          GCP_REGION: ${{ secrets.GCP_REGION }}
          IMAGE_NAME: ${{ inputs.service-name }}
        run: |
          echo "ðŸ”¨ Building Docker image..."

          IMAGE_TAG="${GCP_REGION}-docker.pkg.dev/${GCP_PROJECT_ID}/payment-service/${IMAGE_NAME}:${GITHUB_SHA}"
          IMAGE_LATEST="${GCP_REGION}-docker.pkg.dev/${GCP_PROJECT_ID}/payment-service/${IMAGE_NAME}:latest"

          docker build -t ${IMAGE_TAG} -t ${IMAGE_LATEST} .

          echo "ðŸ“¤ Pushing to Artifact Registry..."
          docker push ${IMAGE_TAG}
          docker push ${IMAGE_LATEST}

          echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_ENV

      - name: Deploy to Cloud Run
        env:
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          GCP_REGION: ${{ secrets.GCP_REGION }}
          SERVICE_NAME: ${{ inputs.service-name }}
        run: |
          echo "ðŸš€ Deploying to Cloud Run..."

          gcloud run deploy ${SERVICE_NAME} \
            --image ${{ env.IMAGE_TAG }} \
            --region ${GCP_REGION} \
            --platform managed \
            --allow-unauthenticated \
            --port 8080 \
            --set-env-vars "PORT=8080,HTTP_PORT=8081,ENVIRONMENT=production,DB_SSL_MODE=require" \
            --set-env-vars "EPX_SERVER_POST_URL=https://secure.epxnow.com,EPX_TIMEOUT=30" \
            --set-env-vars "EPX_CUST_NBR=${{ secrets.EPX_CUST_NBR_PRODUCTION }}" \
            --set-env-vars "EPX_MERCH_NBR=${{ secrets.EPX_MERCH_NBR_PRODUCTION }}" \
            --set-env-vars "EPX_DBA_NBR=${{ secrets.EPX_DBA_NBR_PRODUCTION }}" \
            --set-env-vars "EPX_TERMINAL_NBR=${{ secrets.EPX_TERMINAL_NBR_PRODUCTION }}" \
            --set-env-vars "EPX_MAC=${{ secrets.EPX_MAC_PRODUCTION }}" \
            --set-env-vars "NORTH_MERCHANT_REPORTING_URL=https://api.north.com,NORTH_TIMEOUT=30" \
            --set-env-vars "CALLBACK_BASE_URL=${{ secrets.CALLBACK_BASE_URL_PRODUCTION }}" \
            --set-env-vars "CRON_SECRET=${{ secrets.CRON_SECRET_PRODUCTION }},LOG_LEVEL=info" \
            --set-env-vars "DATABASE_URL=${{ secrets.GCP_DATABASE_URL }}" \
            --set-cloudsql-instances ${{ secrets.GCP_DB_INSTANCE_CONNECTION_NAME }} \
            --cpu 1 \
            --memory 512Mi \
            --min-instances 0 \
            --max-instances 10 \
            --timeout 300 \
            --concurrency 80

          echo "âœ… Production deployment completed successfully"

      - name: Get Service URL
        env:
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          GCP_REGION: ${{ secrets.GCP_REGION }}
          SERVICE_NAME: ${{ inputs.service-name }}
        run: |
          echo "ðŸ“ Getting Cloud Run service URL..."
          SERVICE_URL=$(gcloud run services describe ${SERVICE_NAME} \
            --region ${GCP_REGION} \
            --format 'value(status.url)')

          echo "Production URL: $SERVICE_URL"
          echo "service_url=$SERVICE_URL" >> $GITHUB_OUTPUT
