name: Deploy to Oracle Cloud Staging

on:
  workflow_call:
    inputs:
      service-name:
        required: true
        type: string
        description: 'Name of the service to deploy'
      image-tag:
        required: false
        type: string
        default: 'latest'
        description: 'Docker image tag to deploy'
      oracle-cloud-host:
        required: true
        type: string
        description: 'Oracle Cloud host IP (from infrastructure output)'
      db-host:
        required: true
        type: string
        description: 'Database connection host (from infrastructure output)'
      db-port:
        required: true
        type: string
        description: 'Database connection port (from infrastructure output)'
      db-service-name:
        required: true
        type: string
        description: 'Database service name (from infrastructure output)'
      db-user:
        required: true
        type: string
        description: 'Database user (from infrastructure output)'
    secrets:
      ORACLE_CLOUD_SSH_KEY:
        required: true
      OCIR_REGION:
        required: true
      OCIR_TENANCY_NAMESPACE:
        required: true
      OCIR_USERNAME:
        required: true
      OCIR_AUTH_TOKEN:
        required: true
      ORACLE_DB_PASSWORD:
        required: true
      ORACLE_DB_ADMIN_PASSWORD:
        required: true

jobs:
  migrate:
    name: Run Database Migrations
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Wait for SSH to be ready
        run: |
          echo "â³ Waiting for compute instance SSH to be ready..."
          max_attempts=30
          attempt=1

          while [ $attempt -le $max_attempts ]; do
            echo "Attempt $attempt/$max_attempts: Checking SSH connectivity..."

            if nc -z -w5 ${{ inputs.oracle-cloud-host }} 22 2>/dev/null; then
              echo "âœ… SSH port is open!"
              # Give SSH daemon a few more seconds to fully initialize
              sleep 10
              echo "âœ… SSH is ready for connections"
              exit 0
            fi

            echo "SSH not ready yet, waiting 10 seconds..."
            sleep 10
            attempt=$((attempt + 1))
          done

          echo "âŒ SSH did not become ready after $max_attempts attempts"
          exit 1

      - name: Download SSH Private Key
        uses: actions/download-artifact@v4
        with:
          name: oracle-ssh-key-staging
          path: .

      - name: Set SSH Key Permissions
        run: |
          chmod 600 oracle-staging-key
          ls -la oracle-staging-key

      - name: Wait for cloud-init to complete
        uses: appleboy/ssh-action@master
        with:
          host: ${{ inputs.oracle-cloud-host }}
          username: ubuntu
          key_path: oracle-staging-key
          script: |
            echo "â³ Waiting for cloud-init to complete..."

            # Wait for cloud-init to finish (max 20 minutes)
            # Increased timeout to handle Oracle Instant Client installation
            # and OCIR login which can take additional time
            timeout 1200 cloud-init status --wait || true

            # Verify Docker is installed
            if ! command -v docker &> /dev/null; then
              echo "âŒ Docker not installed after cloud-init completion"
              exit 1
            fi

            # Verify docker-compose is installed
            if ! command -v docker-compose &> /dev/null; then
              echo "âŒ docker-compose not installed after cloud-init completion"
              exit 1
            fi

            # Verify application directory exists
            if [ ! -d ~/payment-service ]; then
              echo "âŒ Application directory not created by cloud-init"
              exit 1
            fi

            echo "âœ… Cloud-init completed successfully"
            echo "   Docker version: $(docker --version)"
            echo "   Docker Compose version: $(docker-compose --version)"

      - name: Download Oracle Wallet
        uses: actions/download-artifact@v4
        with:
          name: oracle-wallet-staging
          path: .

      - name: Upload Oracle Wallet to Compute Instance
        uses: appleboy/scp-action@master
        with:
          host: ${{ inputs.oracle-cloud-host }}
          username: ubuntu
          key_path: oracle-staging-key
          source: oracle-wallet.zip
          target: /home/ubuntu/

      - name: Install Oracle Wallet
        uses: appleboy/ssh-action@master
        with:
          host: ${{ inputs.oracle-cloud-host }}
          username: ubuntu
          key_path: oracle-staging-key
          script: |
            echo "ğŸ“¦ Installing Oracle Wallet..."

            # Unzip wallet
            cd /home/ubuntu
            unzip -o oracle-wallet.zip -d /home/ubuntu/oracle-wallet/

            # Set proper permissions
            chmod 600 /home/ubuntu/oracle-wallet/*

            echo "âœ… Oracle Wallet installed successfully"

      - name: Download Database Init Script
        uses: actions/download-artifact@v4
        with:
          name: db-init-script-staging
          path: .

      - name: Upload Database Init Script to Compute Instance
        uses: appleboy/scp-action@master
        with:
          host: ${{ inputs.oracle-cloud-host }}
          username: ubuntu
          key_path: oracle-staging-key
          source: init_db.sql
          target: /home/ubuntu/

      - name: Initialize Database User
        uses: appleboy/ssh-action@master
        with:
          host: ${{ inputs.oracle-cloud-host }}
          username: ubuntu
          key_path: oracle-staging-key
          script: |
            echo "ğŸ‘¤ Initializing database user..."

            # Oracle Instant Client is pre-installed by cloud-init
            # Set Oracle environment variables
            export LD_LIBRARY_PATH=/opt/oracle/instantclient_21_1:$LD_LIBRARY_PATH
            export PATH=/opt/oracle/instantclient_21_1:$PATH
            export TNS_ADMIN=/home/ubuntu/oracle-wallet

            # Connect as ADMIN and run init script
            # Using ADMIN user to create application user
            ADMIN_CONN_STRING="ADMIN/${{ secrets.ORACLE_DB_ADMIN_PASSWORD }}@${{ inputs.db-service-name }}_high"

            echo "Creating application user if not exists..."
            sqlplus -S "$ADMIN_CONN_STRING" @/home/ubuntu/init_db.sql

            echo "âœ… Database user initialized successfully"

      - name: Run Migrations via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ inputs.oracle-cloud-host }}
          username: ubuntu
          key_path: oracle-staging-key
          script: |
            echo "ğŸ”„ Running database migrations on Oracle Autonomous Database..."

            # Ensure migrations directory exists
            mkdir -p ~/migrations

            # Clone or update repository to get latest migrations
            if [ ! -d ~/payment-service-repo ]; then
              git clone https://github.com/${{ github.repository }}.git ~/payment-service-repo
            else
              cd ~/payment-service-repo && git pull origin ${{ github.ref_name }}
            fi

            # Copy migrations and seeds to local directories
            cp -r ~/payment-service-repo/internal/db/migrations/* ~/migrations/ 2>/dev/null || echo "No migrations to copy"

            # Copy seed data for staging
            mkdir -p ~/seeds
            cp -r ~/payment-service-repo/internal/db/seeds/staging/* ~/seeds/ 2>/dev/null || echo "No seeds to copy"

            # Oracle Instant Client is pre-installed by cloud-init
            # Set Oracle environment variables
            export LD_LIBRARY_PATH=/opt/oracle/instantclient_21_1:$LD_LIBRARY_PATH
            export PATH=/opt/oracle/instantclient_21_1:$PATH
            export TNS_ADMIN=/home/ubuntu/oracle-wallet

            # Build connection string for Oracle (not PostgreSQL!)
            # Oracle connection format: user/password@//host:port/service_name
            DB_CONN_STRING="${{ inputs.db-user }}/${{ secrets.ORACLE_DB_PASSWORD }}@${{ inputs.db-service-name }}_high"

            # Run migrations using SQL*Plus
            cd ~/migrations
            echo "Running migrations..."
            for migration_file in $(ls *.sql | sort); do
              echo "  - Applying migration: $migration_file"
              # Extract only the "Up" section from goose migration files
              sed -n '/-- +goose Up/,/-- +goose Down/p' "$migration_file" | \
                sed '/-- +goose Down/d' | \
                sqlplus -S "$DB_CONN_STRING" @/dev/stdin
            done

            echo "âœ… Migrations completed successfully"

            # Run seed data for staging environment
            echo "ğŸŒ± Seeding staging database..."
            cd ~/seeds
            if [ -n "$(ls -A *.sql 2>/dev/null)" ]; then
              for seed_file in $(ls *.sql | sort); do
                echo "  - Applying seed: $seed_file"
                sqlplus -S "$DB_CONN_STRING" @"$seed_file"
              done
              echo "âœ… Database seeding completed successfully"
            else
              echo "No seed files found, skipping seeding"
            fi

  deploy:
    name: Deploy Application
    needs: migrate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Oracle Container Registry (OCIR)
        run: |
          echo "${{ secrets.OCIR_AUTH_TOKEN }}" | docker login ${{ secrets.OCIR_REGION }}.ocir.io \
            -u "${{ secrets.OCIR_USERNAME }}" \
            --password-stdin

      - name: Build and Push Docker Image to OCIR
        run: |
          IMAGE_TAG="${{ secrets.OCIR_REGION }}.ocir.io/${{ secrets.OCIR_TENANCY_NAMESPACE }}/${{ inputs.service-name }}:${{ github.sha }}"
          IMAGE_LATEST="${{ secrets.OCIR_REGION }}.ocir.io/${{ secrets.OCIR_TENANCY_NAMESPACE }}/${{ inputs.service-name }}:latest"

          echo "ğŸ—ï¸  Building Docker image..."
          docker build -t ${IMAGE_TAG} -t ${IMAGE_LATEST} .

          echo "ğŸ“¤ Pushing image to Oracle Container Registry..."
          docker push ${IMAGE_TAG}
          docker push ${IMAGE_LATEST}

          echo "âœ… Image pushed successfully"

      - name: Download SSH Private Key
        uses: actions/download-artifact@v4
        with:
          name: oracle-ssh-key-staging
          path: .

      - name: Set SSH Key Permissions
        run: chmod 600 oracle-staging-key

      - name: Verify Environment
        uses: appleboy/ssh-action@master
        with:
          host: ${{ inputs.oracle-cloud-host }}
          username: ubuntu
          key_path: oracle-staging-key
          script: |
            echo "ğŸ” Verifying deployment environment..."

            # Ensure Docker is available
            if ! command -v docker &> /dev/null; then
              echo "âŒ Docker not available"
              exit 1
            fi

            # Ensure docker-compose is available
            if ! command -v docker-compose &> /dev/null; then
              echo "âŒ docker-compose not available"
              exit 1
            fi

            echo "âœ… Environment ready for deployment"

      - name: Deploy to Oracle Compute Instance
        uses: appleboy/ssh-action@master
        with:
          host: ${{ inputs.oracle-cloud-host }}
          username: ubuntu
          key_path: oracle-staging-key
          script: |
            echo "ğŸ” Logging into Oracle Container Registry..."
            echo "${{ secrets.OCIR_AUTH_TOKEN }}" | docker login ${{ secrets.OCIR_REGION }}.ocir.io \
              -u "${{ secrets.OCIR_USERNAME }}" \
              --password-stdin

            echo "ğŸ“¥ Pulling latest Docker image..."
            docker pull ${{ secrets.OCIR_REGION }}.ocir.io/${{ secrets.OCIR_TENANCY_NAMESPACE }}/${{ inputs.service-name }}:${{ inputs.image-tag }}

            echo "ğŸ›‘ Stopping existing container..."
            docker-compose -f ~/payment-service/docker-compose.yml down || true

            echo "ğŸš€ Starting new container..."
            cd ~/payment-service
            docker-compose up -d

            echo "â³ Waiting for health check..."
            sleep 10

            echo "ğŸ¥ Checking health..."
            curl -f http://localhost:8081/cron/health || exit 1

            echo "âœ… Deployment successful!"

      - name: Verify Deployment
        run: |
          echo "ğŸ” Verifying deployment..."
          sleep 5
          curl -f http://${{ inputs.oracle-cloud-host }}:8081/cron/health

          echo "âœ… Staging deployment verified"
          echo "ğŸ“ Staging URL: http://${{ inputs.oracle-cloud-host }}:8081"
